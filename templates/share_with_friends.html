<!-- step 3 -->
<script type="text/javascript">
	$j(document).ready(function() {
		// hack to get facebook root into the correct place
		$j('body').prepend($j('#fb-root'));
	});
</script>
<div id="fb-root"></div>
<div id="steps-header">
	<ul class="inline-links form-steps">
		<li id="learn-more">
			<img src="{{PATH}}images/webcam_one.png"/>
		</li><li class="back-line">
		</li><li id="get-involved">
			<img src="{{PATH}}images/pen_two.png"/>			
		</li><li class="back-line">
		</li><li class="active" id="join-us">
			<a class="info" data-target="#directions-container">Directions</a>
			<img src="{{PATH}}images/share_three.png"/>
		</li>
	</ul>
</div>

<div id="watch-area">
</div>

<div id="quote-area">
</div>

<div id="main-area">
	<p class="error-message">{{ERROR_MESSAGE}}</p>
	{{FORM}}
</div>

<div class="modal-overlay-container" id="directions-container">
	<div class="modal-overlay-pane" id="modal-directions">
		<img class="modal-close-button" src="{{PATH}}images/close_button.png"/>
		<h1>How to Spread the Word</h1>
		<ul class="inline-links form-steps">
			<li>
				<img src="{{PATH}}images/webcam_one.png"/>
				<h4>Create a video</h4>
			</li>
			<li>
				<img src="{{PATH}}images/pen_two.png"/>
				<h4>Write a message</h4>
			</li>
			<li class="active">
				<img src="{{PATH}}images/share_three.png"/>
				<h4>Share</h4>
			</li>
		</ul>
		
		<p class="error-message">{{ERROR_MESSAGE}}</p>

		<div id="directions-box">
			<h2>Directions</h2>
			<img id="directions-marker" src="{{PATH}}images/share_three_35.png"/>
			<div id="directions">
				<p>Invite friends to view your video. You can post to your facebook feed, send private messages across facebook, and send email messages to contacts by clicking the appropriate checkbox.</p>
				<p>This page includes a basic message that will be sent to your contacts. You can edit this message.</p>
			</div>
			<img src="{{PATH}}images/multifriend.png" />
		</div>
		<button id="close-button-bottom" class="modal-close-window">Close this Window</button>
	</div>
</div>

<input id="user-video-link" type="hidden" value="{{USER_VIDEO_LINK}}" />
<input id="user-name" type="hidden" value="{{USER_NAME}}" />

<!-- Auto Replace and Hidden Land - this HTML will be moved via javascript -->

<div class="auto-replace" id="contact-holder">
	<div class="contact-tag">Contact Method</div>
	<div id="contact-type-selection">
		<div class="contact-type"><input id="facebook-feed" type="checkbox" name="facebook-feed"/><label for="facebook-feed">Post to your Facebook Feed</label></div>
		<div class="contact-type"><input id="facebook-private" type="checkbox" name="facebook-private"/><label for="facebook-private">Send Private Facebook Messages</label></div>
		<div id="email-holder" class="contact-type"><!-- shoot in form member from form --></div>
	</div>
</div>

<div id="social-message" class="auto-replace" style="display: none">Checkout the video I made for you and the links below as I think you'd be interested in Open Source Ecology.
</div>


<div id="facebook-post-modal" class="modal-overlay-container">
	<br /><br /><br />
	<span id="fb-post-status">Submitting messages...</span>
</div>

<div id="email-modal" class="modal-overlay-container">
	<div id="email-list-modal" class="modal-overlay-pane">
		<img class="modal-close-button" src="{{PATH}}images/close_button.png"/>
		<h3>Enter Email Addresses</h3>
		<div id="email-input-container">
			<div class="email-list-combo">
				<div class="email-input-cluster">
					<div class="mw-label">
						<label>Name</label>
					</div>
					<div class="mw-input">
						<input class="email-names" type="text" />
					</div>
				</div>
				<div class="email-input-cluster">
					<div class="mw-label">
						<label for="ose-truefan-email-input">Email</label>
					</div>
					<div class="mw-input">
						<input class="email-addresses" type="text" name="wpEmailInput[]"/>
					</div>
				</div>
			</div>
		</div>
		<br/>
		<button id="email-list-ok" class="modal-close-window inline-button" type="button">Ok</button>
		<button id="email-list-clear" class="modal-close-window negative-action inline-button" type="button">Clear</button>
	</div>
</div>

<!-- is there an easy way to keep this synced with facebook.js in case we change the text? -->
<style>
	.preview-holder{
		display: none;
		width: 411px; 
		padding-left: 50px; 
		float: left
	}
	.preview-holder h4{
		text-align: center;
	}
	.preview-box{
		width: 379px; 
		color: #333; 
		border: 1px solid #C4CDE0; 
		border-radius: 3px; 
		padding: 13px 15px; 
		font-size: 11px;
	}
	.facebook-preview-link-box{
		background-color: #f6f7f9; 
		border: 1px solid #d3dae8; 
		overflow:hidden;
	}
	.bld{font-weight: bold;}
	.nml{font-weight: normal;}
</style>
<div id="facebook-feed-preview" class="preview-holder">
	<h4>Facebook Feed Preview</h4>
	<div class="preview-box">
		<div class="contact-message-text" style="font-size: 13px; padding-bottom: 13px">This is temporary text.</div>
		<div class="facebook-preview-link-box">
			<img src="http://www.opensourceecology.org/w/ose-logo.png" style="width: 114px; border-right: 1px solid #d3dae8"/>
			<div style="width: 250px; padding: 5px; float:right">
				<div class="bld" style="color: #3B5998">Open Source Ecology</div>
				<div>True Fan Stories</div>
				<div style="padding-top: 11px">A Network of Farmers, Engineers, and Supporters building the Global Village Construction Set.</div>
			</div>
		</div>
	</div>
</div>

<div id="facebook-private-preview" class="preview-holder">
	<h4>Facebook Private Message Preview</h4>
	<div class="preview-box">
		<div style="color: #3B5998; font-weight: bold; font-size: 13px">{{USER_NAME}}</div>
		<div class="" style="font-size: 13px; padding-bottom: 13px">You will have to retype your message for private messages. Facebook does not allow autotmatic text for private messages.</div>
		<div class="facebook-preview-link-box">
			<img src="http://www.opensourceecology.org/w/ose-logo.png" style="width: 114px; border-right: 1px solid #d3dae8"/>
			<div style="width: 250px; padding: 5px; float:right">
				<div class="bld" style="color: #3B5998">Open Source Ecology</div>
				<div>True Fan Stories</div>
				<div style="padding-top: 11px">A Network of Farmers, Engineers, and Supporters building the Global Village Construction Set.</div>
			</div>
		</div>
	</div>
</div>

<div id="ose-truefan-email-check-preview" class="preview-holder">
	<h4>Email Message Preview</h4>
	<div class="preview-box" style="font-size: 13px">
		<div class="bld">To: <span id="email-preview-to" class="nml"></span></div>
		<div class="bld">From: <span class="nml">{{USER_NAME}}</span></div>
		<div style="padding-top: 7px">Hey <span id="email-preview-to-name"></span>,</div>
		<div class="contact-message-text" style="font-size: 13px; padding: 7px 0">Temporary text.</div>
		{{USER_VIDEO_LINK}} 
	</div>
</div>

<div style="clear:both; display: block;">
	<button id="revokeAuth" type="button" onclick="uninstallApp()">Revoke/Uninstall</button>
	<button id="logout" type="button" onclick="logout()">Logout</button>
</div>

<script type="text/javascript">
	// These two json objects take content from first selector and put it in second; see dynamic.js
	var autoReplaceArray = {
		"#contact-holder":"#mw-form-section-contact-area"
	}
	var autoInputArray = {
		"#social-message":"#ose-truefan-friends-message"
	}

	var havePostedToFeed = false;
	var havePostedPrivateMessages = false;
	var gAppID = '130775487070378';
	var facebookSubmit = 0;
	var FB_AUTH_STATUS = 'undefined';

	console.log('facebook js api');
	
	// Load the SDK Asynchronously
	(function(d){
		var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
		if (d.getElementById(id)) {return;}
		js = d.createElement('script'); js.id = id; js.async = true;
		js.src = "//connect.facebook.net/en_US/all.js";
		ref.parentNode.insertBefore(js, ref);
	}(document));

	//Initialize the Facebook SDK
	window.fbAsyncInit = function() {
		FB.init({
			appId: gAppID,
			channelUrl : '//test.opensourceecology.org/w/extensions/TrueFans/lib/channel.php',
			status: true,
			cookie: true,
			xfbml: false,
			frictionlessRequests: true,
			useCachedDialogs: true,
			oauth: true
		});

		FB.Event.subscribe('auth.statusChange', function(session) {
			console.log('Got the user\'s session: ', session);
			console.log(session.status);
		
			if (session && session.status != 'not_authorized') {
				if (session.authResponse['accessToken']) {
					// connected
					FB_AUTH_STATUS = 'connected';
				}
				// FIXME: else condition?
			} else if (session === undefined) {
				// not connected
				FB_AUTH_STATUS = 'not_connected';
			}
			else if (session && session.status == 'not_authorized') {
				// not authorized
				FB_AUTH_STATUS = 'not_authorized';
			}
		});
	};
	
	// FIXME: for tags are incorrect
	var email_inputs = '<div class="email-list-combo">'+
							'<div class="email-input-cluster">'+
								'<div class="mw-label">'+
									'<label>Name</label>'+
								'</div>'+
								'<div class="mw-input">'+
									'<input class="email-names" type="text" />'+
								'</div>'+
							'</div>'+
							'<div class="email-input-cluster">'+
								'<div class="mw-label">'+
									'<label for="ose-truefan-email-input">Email</label>'+
								'</div>'+
								'<div class="mw-input">'+
									'<input class="email-addresses" type="text" name="wpEmailInput[]"/>'+
								'</div>'+
							'</div>'+
						'</div>';
	
	$j(document).ready(function() {
		for (var source in autoReplaceArray) {
			if (autoReplaceArray.hasOwnProperty(source)) {
				var sourceHtml = $j(source).html();
				$j(autoReplaceArray[source]).html(sourceHtml);
				$j(source).empty();
			}
		}

		for (var source in autoInputArray) {
			if (autoInputArray.hasOwnProperty(source)) {
				var sourceText = $j(source).html();
				$j(autoInputArray[source]).val(sourceText);
				$j(source).empty();
			}
		}
	
		console.log('**logging**');
		$j('#bodyContent').css('min-height', $j(window).height() -250);
		console.log($j(window).height());
		
		$j('#ose-truefan-email-check').parent().appendTo('#email-holder');

		$j('.mw-htmlform-field-HTMLTextArray').empty();
		$j('#email-modal').appendTo('.mw-htmlform-field-HTMLTextArray');
		$j('.email-addresses').keyup(addEmailInput);
		$j('#email-list-clear').click(function(){
			$j('#email-input-container').empty();
			dummyEvent = {'value':'q'};
			addEmailInput(dummyEvent);
			$j('#ose-truefan-email-check').removeAttr('checked');	
			$j('#email-preview-to').empty();
			$j('#email-preview-to-name').empty();
			$j('#ose-truefan-email-check-preview').css('display','none');
		});
		$j('#email-list-ok').click(function(){
			console.log('processEmail')
			var addresses = new Array();
			// TODO: Remove empty email inputs
			$j('#email-input-container .email-list-combo').each( function(index) {
				var name = $j(this).find('.email-names').val();
				var address = $j(this).find('.email-addresses').val();
				if(address != '') {
					addresses.push(name + ':<' + address + '>');
				}
			});
			$j('#email-preview-to').empty();
			$j('#email-preview-to-name').empty();
			$j.each(addresses, function(index, value){
				value = value.replace(/[<|>]/g, '');
				var parts = value.split(':');
				$j('#email-preview-to').append("(" + parts[1] + ") ");
				$j('#email-preview-to-name').append("(" + parts[0] + ") ");
			});
			$j('input[name=wpEmailList]').val(addresses.join(','));
		});
		
		function addEmailInput(e)
		{
			// Any input that contains value creates a single new input, and pays the process forward
			if(this.value != '') {
				$j(this).unbind('keyup');
				$j('#email-input-container').append(email_inputs);
				$j('#trueFanForm .email-input-cluster input:last').keyup(addEmailInput);
			}
		}
		
		// initialize the preview messages
		$j('.contact-message-text').html($j('#ose-truefan-friends-message').val());
		$j('#ose-truefan-friends-message').keyup(function(){
			$j('.contact-message-text').html($j('#ose-truefan-friends-message').val());
		});
		$j('.contact-type input').click(function(){
			console.log('got some contact type ing going on');
			if($j(this).is(':checked')){
				var messageText = $j('#ose-truefan-friends-message').val();
				console.log('Input: ' + $j(this).attr('id') + ' is active.' );
				switch($j(this).attr('id')) {
					case 'ose-truefan-email-check':
						$j('#email-modal').css('visibility', 'visible');
						$j('#email-preview-to').empty();
						$j('#email-preview-to-name').empty();
						$j('#ose-truefan-email-check-preview').css('display','block');
						break;
					case 'facebook-feed':
						$j('#facebook-feed-preview').css('display','block');
						break;
					case 'facebook-private':
						$j('#facebook-private-preview').css('display','block');
						break;
				}
			} else {
				switch($j(this).attr('id')) {
					case 'ose-truefan-email-check':
						$j('#ose-truefan-email-check-preview').css('display','none');
						break;
					case 'facebook-feed':
						$j('#facebook-feed-preview').css('display','none');
						break;
					case 'facebook-private':
						$j('#facebook-private-preview').css('display','none');
						break;
				}
			}
		});
		
		// change the name of submit button to create correct submit behavior for jQuery
		$j('.mw-htmlform-submit').attr('name','submittens');
		$j('#trueFanForm').submit(function(e) {
			$j('#facebook-post-modal').css('visibility','visible');
			if($j('#facebook-feed').is(':checked') && !havePostedToFeed){
				$j('#fb-post-status').html('Posting to facebook feed...');
				postToMyFeed();
				return false;	
			} else if($j('#facebook-private').is(':checked') && !havePostedPrivateMessages){
				$j('#fb-post-status').html('Choose friends to message...');
				var userLink = $j('#user-video-link').val();
				console.log(userLink);
				var userName = $j('#user-name').val();
				FB.ui({
		        	method: 'send',
		        	name: userName + ' - OSE True Fan Story',
		        	link: userLink,
					picture: 'http://www.opensourceecology.org/w/ose-logo.png',
					description: 'A Network of Farmers, Engineers, and Supporters Building the Global Village Construction Set',
		        }, 
				function(response){
					if (response && response.success){
						$j('#fb-post-status').html('Private messages successfully sent to facebook.');
						console.log('post was teh success');
					} else {
						console.log(response);
						console.log('did not post private messages');
						$j('#fb-post-status').html('Unable to send private facebook messages.');
					}
					havePostedPrivateMessages = true;
					$j('#trueFanForm').submit();
				});
				return false;	
			} else {
				return true;
			}
		});
	});

	function postToMyFeed()
	{
		executeOnAuth(function(response) {
			var messageText = $j('#ose-truefan-friends-message').val();
			var userLink = $j('#user-video-link').val();
			var userName = $j('#user-name').val();
			var postData =
			{
				message: messageText,
				name: userName + ' - OSE True Fan Story',
				link: userLink,
				picture: 'http://www.opensourceecology.org/w/ose-logo.png',
				description: 'A Network of Farmers, Engineers, and Supporters Building the Global Village Construction Set',
			};

			FB.api('/me/feed', 'post', postData, function(response) {
				if (!response || response.error) {
					// TODO: Relay this message back UX
					console.log(response);
					console.log('Error occured posting to feed.');
					alert('Error occured');
				} else {
					console.log('Posted to facebook feed.');
					havePostedToFeed = true;
					$j('#trueFanForm').submit();
				}
			});
		/*
			// Now publish an action the user who made the video's wall/timeline
			FB.api('/me/osetruefantest:join', 'post',
			{ cause: 'http://www.wordpages.org/facebook/fb_obj.html' },
				function(response) {
					if (!response || response.error) {
						console.log(response);
						alert('Error occured. Unable to publish action on your timeline.'+response.error);
					} else {
						alert('Join Cause action was successful! Action ID: ' + response.id);
					}
			});*/

		});
	}

	function uninstallApp() {
	FB.api({method: 'auth.revokeAuthorization'},
		function(response) {
			console.log('Revoked authorization.');
			window.location.reload();
		});
	}

	function logout() {
		FB.logout(function(response) {
			window.location.reload();
		});
	}

	function executeOnAuth(callback)
	{
		console.log(FB_AUTH_STATUS);
		if(FB_AUTH_STATUS == 'connected') {
			callback();
		} else {
			FB.login(function(response) {
				if(response.authResponse) {
					console.log('authed now calling callback');
					callback();
				} else {
					// !! Output do common App debug outlets
					console.log('User did not fully authorize. Callback function did not execute.');
				}
			}, {scope: 'publish_stream'}); 
		}
	}
</script>

